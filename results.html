<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detailed Results - ExamAce</title>
    <style>
        /* Reset and base styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; line-height: 1.6; color: #374151; background-color: #f9fafb; }
        :root {
            --primary: #15803d; --primary-foreground: #ffffff; --secondary: #84cc16;
            --background: #ffffff; --foreground: #374151; --card: #ffffff;
            --muted: #f3f4f6; --muted-foreground: #6b7280; --border: #e5e7eb;
            --destructive: #dc2626; --warning: #f59e0b; --success: #16a34a;
        }
        /* Navigation */
        .navbar { background-color: var(--card); border-bottom: 1px solid var(--border); padding: 0 1rem; position: sticky; top: 0; z-index: 100; }
        .nav-container { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; height: 4rem; }
        .nav-brand { font-size: 1.5rem; font-weight: 700; color: var(--primary); text-decoration: none; }
        .nav-links { display: flex; gap: 2rem; list-style: none; }
        .nav-link { color: var(--foreground); text-decoration: none; font-weight: 500; transition: color 0.2s; }
        .nav-link:hover, .nav-link.active { color: var(--primary); }
        .nav-user { display: flex; align-items: center; gap: 1rem; }
        .user-avatar { width: 2rem; height: 2rem; background-color: var(--primary); color: var(--primary-foreground); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .logout-btn { background: none; border: 1px solid var(--border); color: var(--foreground); padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; transition: all 0.2s; }

        /* Mobile menu */
        .mobile-menu-btn { display: none; background: none; border: none; font-size: 1.75rem; cursor: pointer; color: var(--foreground); }
        .mobile-menu { display: none; background-color: var(--card); border-top: 1px solid var(--border); padding: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .mobile-menu.active { display: block; }
        .mobile-nav-links { list-style: none; display: flex; flex-direction: column; gap: 1rem; }
        .mobile-nav-links .nav-link { display: block; padding: 0.5rem 0; }

        /* Main Content */
        .main-container { max-width: 1400px; margin: 0 auto; padding: 2rem 1rem; }
        #loading-state { text-align: center; padding: 4rem; }

        .summary-header { background: linear-gradient(135deg, var(--primary), #166534); color: white; border-radius: 0.75rem; padding: 2rem; margin-bottom: 2rem; text-align: center; }
        .summary-title { font-size: 1.25rem; opacity: 0.9; }
        .summary-test-name { font-size: 2rem; font-weight: 700; margin: 0.5rem 0; }
        .summary-score { font-size: 4.5rem; font-weight: 800; margin: 1rem 0; }
        .summary-stats { display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-top: 1.5rem; }
        .summary-stat { text-align: center; }
        .summary-stat-value { font-size: 1.75rem; font-weight: 600; }
        .summary-stat-label { font-size: 0.875rem; opacity: 0.8; }

        .results-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; align-items: start; }
        .card { background-color: var(--card); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; }
        .card-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
        
        .question-filter { margin-bottom: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .filter-btn { background: var(--muted); border: 1px solid var(--border); color: var(--muted-foreground); padding: 0.5rem 1rem; border-radius: 999px; cursor: pointer; transition: all 0.2s; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .review-question { margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
        .review-question:last-child { border-bottom: none; }
        .review-question-header { display: flex; justify-content: space-between; align-items: center; font-weight: 600; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;}
        .review-question-topic { font-size: 0.8rem; background-color: var(--muted); padding: 0.2rem 0.6rem; border-radius: 0.25rem; color: var(--muted-foreground);}
        .status-tag { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.8rem; font-weight: 500; }
        .status-correct { background-color: #dcfce7; color: #15803d; }
        .status-incorrect { background-color: #fee2e2; color: #b91c1c; }
        .status-unanswered { background-color: #ffedd5; color: #9a3412; }
        
        .review-options .option { display: flex; gap: 1rem; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem; border: 1px solid var(--border); }
        .review-options .option.correct-answer { background-color: #dcfce7; border-color: #4ade80; }
        .review-options .option.incorrect-choice { background-color: #fee2e2; border-color: #f87171; text-decoration: line-through; }
        .review-options .option-label { font-weight: 600; }
        
        .solution { margin-top: 1rem; padding: 1rem; background-color: #e0f2fe; border-left: 4px solid #38bdf8; }
        .solution h4 { color: #0369a1; margin-bottom: 0.5rem; }
        .solution ol { padding-left: 1.25rem; }
        .solution li { margin-bottom: 0.5rem; }
        .solution .conclusion { margin-top: 1rem; font-weight: 600; }

        .sidebar-card { position: sticky; top: 5rem; }
        .subject-breakdown .subject-item { margin-bottom: 1rem; }
        .subject-header { display: flex; justify-content: space-between; font-weight: 500; margin-bottom: 0.5rem; }
        .progress-bar { width: 100%; height: 0.5rem; background-color: var(--muted); border-radius: 999px; overflow: hidden; }
        .progress-fill { height: 100%; background-color: var(--primary); transition: width 0.5s ease; }
        
        .time-analysis .time-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
        .time-analysis .time-item:last-child { border-bottom: none; }
        .time-label { color: var(--muted-foreground); }
        .time-value { font-weight: 600; }

        .action-buttons { margin-top: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .btn { padding: 0.75rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; text-decoration: none; text-align: center; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-primary { background-color: var(--primary); color: white; border: 1px solid var(--primary); }
        .btn-outline { background-color: transparent; color: var(--primary); border: 1px solid var(--primary); }
        
        @media (max-width: 992px) {
            .results-grid { grid-template-columns: 1fr; }
            .sidebar-card { position: static; }
        }
        @media (max-width: 768px) {
            .nav-links, .nav-user { display: none; }
            .mobile-menu-btn { display: block; }
            .summary-score { font-size: 3.5rem; }
            .summary-test-name { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="dashboard.html" class="nav-brand">ExamAce</a>
            <ul class="nav-links">
                <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="test-selection.html" class="nav-link">Mock Tests</a></li>
           
                <li><a href="resources.html" class="nav-link">Resources</a></li>
                <li><a href="tips.html" class="nav-link">Tips & Revision</a></li>
                 <li><a href="info.html" class="nav-link">Exam Info</a></li>
            </ul>
            <div class="nav-user">
                <div class="user-avatar" id="user-avatar">U</div>
                <button class="logout-btn" id="logout-btn">Logout</button>
            </div>
            <button class="mobile-menu-btn" id="mobile-menu-btn">&#9776;</button>
        </div>
        <div class="mobile-menu" id="mobile-menu">
            <ul class="mobile-nav-links">
                <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="test-selection.html" class="nav-link">Mock Tests</a></li>
           
                <li><a href="resources.html" class="nav-link">Resources</a></li>
                <li><a href="tips.html" class="nav-link">Tips & Revision</a></li>
                 <li><a href="info.html" class="nav-link">Exam Info</a></li>
                <li><a href="#" id="mobile-logout-btn" class="nav-link">Logout</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-container">
        <div id="loading-state"><h1>Calculating Results...</h1></div>
        <div id="results-content" style="display:none;">
            <section class="summary-header">
                <div class="summary-title">Your Score for</div>
                <h1 class="summary-test-name" id="test-name">Test Name</h1>
                <div class="summary-score" id="final-score">0 / 0</div>
                <div class="summary-stats">
                    <div class="summary-stat"><div class="summary-stat-value" id="stat-correct">0</div><div class="summary-stat-label">Correct</div></div>
                    <div class="summary-stat"><div class="summary-stat-value" id="stat-incorrect">0</div><div class="summary-stat-label">Incorrect</div></div>
                    <div class="summary-stat"><div class="summary-stat-value" id="stat-unanswered">0</div><div class="summary-stat-label">Unanswered</div></div>
                    <div class="summary-stat"><div class="summary-stat-value" id="stat-accuracy">0%</div><div class="summary-stat-label">Accuracy</div></div>
                </div>
            </section>

            <div class="download-message" style="text-align: center; margin-bottom: 2rem; color: var(--muted-foreground);">
                <p>The solution is downloaded automatically into your device.</p>
            </div>

            <div class="results-grid">
                <div class="card" id="answer-review-card">
                    <h2 class="card-title">Detailed Analysis</h2>
                    <div class="question-filter" id="question-filter">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="correct">Correct</button>
                        <button class="filter-btn" data-filter="incorrect">Incorrect</button>
                        <button class="filter-btn" data-filter="unanswered">Unanswered</button>
                    </div>
                    <div id="review-container"></div>
                </div>

                <div class="sidebar">
                    <div class="card sidebar-card">
                        <div class="subject-breakdown">
                            <h2 class="card-title">Subject-wise Performance</h2>
                            <div id="subject-container"></div>
                        </div>
                        <div class="time-analysis" style="margin-top: 2rem;">
                             <h2 class="card-title">Time Analysis</h2>
                             <div id="time-container"></div>
                        </div>
                         <div class="action-buttons">
                         
                            <a href="test-selection.html" class="btn btn-outline">Take Another Test</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        // --- SUPABASE CREDENTIALS ---
        const SUPABASE_URL = 'https://evetjiyruynvqhjfmuny.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2ZXRqaXlydXludnFoamZtdW55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1ODIyNjUsImV4cCI6MjA3NTE1ODI2NX0.5wjRCHPesj_4OywiFyFyh3uuYtD8zOGBY9aARUAOmxU';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        class DetailedResultsPage {
            constructor() {
                this.results = null;
                this.user = null;
                this.solutionsDownloaded = false; // Flag to prevent double download
                
                this.checkAuthAndLoad();
                this.initializeEventListeners();
            }
            
            async checkAuthAndLoad() {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session && session.user) {
                    this.user = session.user;
                    document.getElementById('user-avatar').textContent = (session.user.email || 'U').charAt(0).toUpperCase();
                    this.loadResults();
                } else {
                    console.log("No user is signed in. Redirecting to login.");
                    window.location.href = 'login.html';
                }
            }
            
            initializeEventListeners() {
                const handleLogout = () => supabase.auth.signOut().catch(e => console.error("Logout error:", e));
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
                document.getElementById('mobile-logout-btn').addEventListener('click', handleLogout);

                document.getElementById('mobile-menu-btn').addEventListener('click', () => {
                     document.getElementById('mobile-menu').classList.toggle('active');
                });
            }

            downloadSolutions() {
                if (!this.results || this.solutionsDownloaded) return; // Check flag here
                this.solutionsDownloaded = true; // Set flag to true

                let solutionText = `Solutions for: ${this.results.testData.title}\n`;
                solutionText += "========================================\n\n";

                this.results.testData.questions_data.forEach((q, index) => {
                    solutionText += `Q${index + 1}: ${q.questionText}\n`;
                    // Check if questionImageUrl exists, if so add it (for reference)
                    if (q.questionImageUrl) {
                         solutionText += ` (Image URL: ${q.questionImageUrl})\n`;
                    }
                    
                    q.options.forEach((option, optIndex) => {
                        solutionText += `  ${String.fromCharCode(65 + optIndex)}. ${option}\n`;
                    });
                    const correctOptionLetter = String.fromCharCode(65 + q.correctAnswer);
                    const correctOptionText = q.options[q.correctAnswer];
                    solutionText += `\nCorrect Answer: ${correctOptionLetter}. ${correctOptionText}\n`;
                    
                    let formattedSolution = q.solution || 'No detailed solution available.';
                    formattedSolution = formattedSolution.replace(/<br>/g, '\n').replace(/Solution: /g, '');
                    const steps = formattedSolution.split('\n').map(s => s.trim()).filter(s => s);
                    
                    solutionText += `Solution:\n`;
                    steps.forEach(step => {
                        solutionText += `- ${step}\n`;
                    });

                    solutionText += "----------------------------------------\n\n";
                });

                const blob = new Blob([solutionText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const fileName = `${this.results.testData.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_solutions.txt`;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            loadResults() {
                const resultsStr = sessionStorage.getItem('test_results');
                if (!resultsStr) {
                    document.getElementById('loading-state').innerHTML = '<h1>No results found.</h1>';
                    return;
                }
                try {
                    this.results = JSON.parse(resultsStr);
                 
                    this.renderPage();
                    this.downloadSolutions(); 
                } catch (error) {
                    console.error('Error parsing results:', error);
                    document.getElementById('loading-state').innerHTML = '<h1>Error loading results data.</h1>';
                }
            }
            
            
            renderPage() {
                this.renderSummary();
                this.renderSubjectBreakdown();
                this.renderTimeAnalysis();
                this.renderAnswerReview();
                this.setupFilters();

                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('results-content').style.display = 'block';
            }

            renderSummary() {
                const attempted = this.results.correct + this.results.incorrect;
                const accuracy = attempted > 0 ? ((this.results.correct / attempted) * 100).toFixed(1) : 0;

                document.getElementById('test-name').textContent = this.results.testData.title;
                document.getElementById('final-score').textContent = `${this.results.finalScore} / ${this.results.testData.marks}`;
                document.getElementById('stat-correct').textContent = this.results.correct;
                document.getElementById('stat-incorrect').textContent = this.results.incorrect;
                document.getElementById('stat-unanswered').textContent = this.results.unanswered;
                document.getElementById('stat-accuracy').textContent = `${accuracy}%`;
            }

            renderSubjectBreakdown() {
                const container = document.getElementById('subject-container');
                container.innerHTML = '';
                const subjects = this.results.subjectWise;
                for (const subjectName in subjects) {
                    const data = subjects[subjectName];
                    const attempted = data.correct + data.incorrect;
                    const accuracy = attempted > 0 ? ((data.correct / attempted) * 100) : 0;
                    container.innerHTML += `
                        <div class="subject-item">
                            <div class="subject-header">
                                <span>${subjectName}</span>
                                <span>${accuracy.toFixed(1)}% Acc</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" style="width: ${accuracy}%"></div></div>
                        </div>`;
                }
            }
            
            renderTimeAnalysis() {
                const container = document.getElementById('time-container');
                const timeTaken = this.results.timeTaken || 0;
                const attemptedCount = this.results.correct + this.results.incorrect;
                const avgTime = attemptedCount > 0 ? (timeTaken / attemptedCount).toFixed(0) : 0;
                const formatTime = (s) => `${Math.floor(s/60)}m ${s%60}s`;

                container.innerHTML = `
                    <div class="time-item"><span class="time-label">Time Taken</span><span class="time-value">${formatTime(timeTaken)}</span></div>
                    <div class="time-item"><span class="time-label">Total Time</span><span class="time-value">${this.results.testData.duration}m 0s</span></div>
                    <div class="time-item"><span class="time-label">Avg. Time/Ques</span><span class="time-value">${avgTime}s</span></div>
                `;
            }

            renderAnswerReview(filter = 'all') {
                const container = document.getElementById('review-container');
                container.innerHTML = '';
                
                this.results.testData.questions_data.forEach((q, index) => {
                    const userAnswer = this.results.answers[index];
                    const isCorrect = userAnswer === q.correctAnswer;
                    let status = (userAnswer !== undefined) ? (isCorrect ? 'correct' : 'incorrect') : 'unanswered';
                    
                    if (filter !== 'all' && filter !== status) return;
                    
                    let formattedSolution = q.solution || 'No detailed solution available.';
                    // Safely handle solution formatting by splitting on <br> tags
                    const steps = formattedSolution.replace(/Solution: /g, '').split(/<br\s*\/?>/i);
                    let solutionHtml = '';
                    
                    // If multiple steps are found, format as list
                    if (steps.length > 1) {
                         const conclusion = steps.pop(); // Assume last element is conclusion
                         solutionHtml = `<ol>${steps.map(step => `<li>${step.trim()}</li>`).join('')}</ol><p class="conclusion">${conclusion.trim()}</p>`;
                    } else {
                         solutionHtml = `<p>${formattedSolution}</p>`;
                    }
                    
                    // Check for image URL
                    const imageHtml = q.questionImageUrl 
                        ? `<div style="margin-top: 1rem;"><img src="${q.questionImageUrl}" alt="Question Image" style="max-width: 100%; max-height: 200px; border-radius: 0.25rem; border: 1px solid var(--border);"></div>` 
                        : '';


                    container.innerHTML += `
                        <div class="review-question" data-status="${status}">
                            <div class="review-question-header">
                                <span><b>Q${index + 1}:</b> (${q.subject})</span>
                                <div>
                                    <span class="review-question-topic">${q.topic || 'General'}</span>
                                    <span class="status-tag status-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                                </div>
                            </div>
                            <p>${q.questionText}</p>
                            
                            ${imageHtml}
                            
                            <div class="review-options">
                                ${q.options.map((option, optIndex) => `
                                    <div class="option 
                                        ${optIndex === q.correctAnswer ? 'correct-answer' : ''}
                                        ${optIndex === userAnswer && !isCorrect ? 'incorrect-choice' : ''}
                                    ">
                                        <span class="option-label">${String.fromCharCode(65 + optIndex)}.</span>
                                        <span>${option}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="solution">
                                <h4>Solution:</h4>
                                ${solutionHtml}
                            </div>
                        </div>
                    `;
                });
            }
            
            setupFilters() {
                const filterContainer = document.getElementById('question-filter');
                filterContainer.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        filterContainer.querySelector('.active').classList.remove('active');
                        e.target.classList.add('active');
                        this.renderAnswerReview(e.target.dataset.filter);
                    }
                });
            }
        }

        new DetailedResultsPage();
    </script>
</body>
</html>
